"""
Vulnerability submission handler for security reports.
"""

import asyncio
import json
import logging
from typing import Dict, Any
from .base import BaseSubmissionHandler, SubmissionResult


class VulnerabilitySubmissionHandler(BaseSubmissionHandler):
    """Handler for vulnerability report submissions."""
    
    def get_handler_type(self) -> str:
        return "vulnerability"
    
    def get_submission_schema(self) -> Dict[str, Any]:
        """Return the OpenAI function schema for vulnerability submissions."""
        return {
            "type": "function",
            "function": {
                "name": "submit",
                "description": "Submit a vulnerability report for processing",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "title": {"type": "string", "description": "Vulnerability title"},
                        "asset": {"type": "string", "description": "Affected asset"},
                        "vuln_type": {"type": "string", "description": "Type of vulnerability"},
                        "severity": {"type": "string", "description": "Severity rating"},
                        "description": {"type": "string", "description": "Detailed description"},
                        "repro_steps": {"type": "string", "description": "Reproduction steps"},
                        "impact": {"type": "string", "description": "Impact summary"},
                        "cleanup": {"type": "string", "description": "Cleanup instructions"}
                    },
                    "required": ["title", "asset", "vuln_type", "severity", "description", "repro_steps", "impact", "cleanup"]
                }
            }
        }
    
    async def submit(self, submission_data: Dict[str, Any]) -> SubmissionResult:
        """Submit vulnerability report directly to Slack (benchmark mode)."""
        # Build vulnerability report payload
        payload = {
            "title": submission_data["title"],
            "asset": submission_data["asset"],
            "vuln_type": submission_data["vuln_type"],
            "severity": submission_data["severity"],
            "description": submission_data["description"],
            "repro_steps": submission_data["repro_steps"],
            "impact": submission_data["impact"],
            "cleanup": submission_data["cleanup"]
        }
        
        await self._send_directly_to_slack(payload)
        
        result = SubmissionResult(
            success=True,
            message=f"‚úÖ Vulnerability report sent to Slack: {payload['title']} (benchmark mode)",
            details=payload
        )
        
        await self.log_submission(submission_data, result)
        return result
    
    async def _send_directly_to_slack(self, payload: Dict[str, Any]) -> None:
        """Send vulnerability report directly to Slack (benchmark mode)."""
        webhook_url = self.config.get("slack_webhook_url")
        
        try:
            # Use curl to post to webhook
            process = await asyncio.create_subprocess_exec(
                "curl", "-X", "POST",
                "-H", "Content-Type: application/json",
                "--data", json.dumps(payload),
                webhook_url,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE
            )
            
            stdout, stderr = await process.communicate()
            
            if process.returncode == 0:
                logging.info("‚úÖ Slack vulnerability report sent (benchmark mode)")
                
                # Log vulnerability to running file
                await self._log_vulnerability_submission(payload)
            else:
                error_msg = stderr.decode() if stderr else "Unknown error"
                logging.error(f"‚ùå Failed to send Slack report: {error_msg}")
                
        except Exception as e:
            logging.error(f"‚ùå Error sending Slack report: {e}")
    
    async def _log_vulnerability_submission(self, payload: Dict[str, Any]) -> None:
        """Log vulnerability submission to running vulnerability log file."""
        import aiofiles
        from datetime import datetime, timezone
        
        vuln_log_file = self.session_dir / "vulnerabilities_found.log"
        
        timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
        log_entry = f"""
=== VULNERABILITY SUBMITTED TO SLACK ===
Timestamp: {timestamp}
Title: {payload['title']}
Asset: {payload['asset']}
Type: {payload['vuln_type']}
Severity: {payload['severity']}

Description:
{payload['description']}

Reproduction Steps:
{payload['repro_steps']}

Impact:
{payload['impact']}

Cleanup:
{payload['cleanup']}
================================================

"""
        
        try:
            async with aiofiles.open(vuln_log_file, 'a') as f:
                await f.write(log_entry)
            logging.info(f"üìù Logged vulnerability to {vuln_log_file}")
        except Exception as e:
            logging.error(f"‚ùå Failed to log vulnerability: {e}")